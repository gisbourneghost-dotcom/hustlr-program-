<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ADMIN PAGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  gap: 5px;
  align-items: flex-start;
  padding: 40px 20px;
  font-family: 'Inter', sans-serif;
  flex-direction: row;
}

.productForm {
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 400px;
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

h1 {
  color: #333;
  font-weight: 600;
  font-size: 24px;
}

.button-group {
  display: flex;
  gap: 10px;
}

.btn {
  background-color: #667eea;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
}

.photo-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.photo-preview {
  background-color: whitesmoke;
  width: 250px;
  height: 250px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #555;
  overflow: hidden;
}

#Btn {
  padding: 10px 20px;
  background-color: #764ba2;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

form input,
form textarea,
form select {
  width: 95%;
  padding: 12px;
  align-items: center;
  margin-bottom: 15px;
  border: 2px solid #4995e2;
  border-radius: 8px;
  font-size: 16px;
}

form textarea {
  resize: vertical;
  min-height: 80px;
}

.flex {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.flex input, .flex select {
  flex: 1;
}

.submit-btn {
  text-align: center;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 20px;
  font-weight: 600;
  cursor: pointer;
  width: 50%;
}

.products{
   background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 400px;
}
.row{
  display: flex;
  flex-direction: row;
  justify-content: space-between;
}

#Go{
   background-color: #667eea;
  color: white;
  font-size: 16px;
  border: none;
  padding: 5px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
  margin-top: 10px;
}

.product-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  background-color: #f9f9f9;
}

.product-card img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  margin-bottom: 10px;
}

.product-card h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.product-card p {
  margin: 5px 0;
  color: #666;
}

.product-card button {
  background-color: #667eea;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 5px;
  margin-top: 10px;
}

.product-card button:last-child {
  background-color: #e74c3c;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}

.error {
  color: #e74c3c;
  text-align: center;
  padding: 20px;
}

@media (max-width: 768px) {
  body {
    flex-direction: column;
    align-items: center;
  }
  
  .productForm, .products {
    max-width: 100%;
  }
}
</style>
</head>
<body>
  <div class="products">
    <div class="row">
    <h1>Product List</h1>
    <button id="Go" class="View">View Products</button>
    </div>
    <div id="productList" class="loading">Loading products...</div>
  </div>

  <div class="productForm">
    <div class="header-row">
      <h2>ADMIN PAGE</h2>
      <div class="button-group">
        <button type="button" class="btn" onclick="refreshForm()">Refresh</button>
      </div>
    </div>

    <div class="photo-row">
      <div class="photo-preview" id="Photoarea">Photo</div>
      <button id="Btn">Tap for Photo</button>
    </div>

    <form id="productForm">
      <input type="text" id="productName" placeholder="Weka jina la bidhaa" required />
      <textarea id="productDescription" placeholder="Maelezo ya Bidhaa" required></textarea>

      <div class="flex">
        <input type="text" id="productSize" placeholder="Size" required />
        <input type="text" id="productBrand" placeholder="Brand" required />
        <input type="number" id="productPrice" placeholder="Bei" required step="0.01" />
      </div>
      
      <select id="productCurrency" required>
        <option value="">Currency</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="TZS">TZS</option>
      </select>
      

      <div class="submit-btn">
        <button type="submit" class="btn-primary">Submit</button>
      </div>
    </form>
  </div>

<script>
///////////////////////////////
// CONFIG
///////////////////////////////
const API_BASE = "http://localhost:4000";
const CLOUD_NAME = "dbq2swcjo";
const UPLOAD_PRESET = "Website_post";

document.addEventListener("DOMContentLoaded", () => {
    const photoArea = document.getElementById("Photoarea");
    const photoBtn = document.getElementById("Btn");
    const productForm = document.getElementById("productForm");
    const productList = document.getElementById("productList");

    let selectedFile = null;
    let editingProductId = null;
    let currentImageUrl = null;

    // Hidden file input
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.style.display = "none";
    document.body.appendChild(fileInput);

    // Open file picker
    photoBtn.addEventListener("click", (e) => {
        e.preventDefault();
        fileInput.click();
    });

    // Show preview
    fileInput.addEventListener("change", () => {
        if (!fileInput.files || !fileInput.files[0]) return;

        selectedFile = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            photoArea.innerHTML = `
                <img src="${e.target.result}" style="max-width:100%; height:auto;" />
            `;
        };

        reader.readAsDataURL(selectedFile);
    });

    ///////////////////////////////////////////
    // CLOUDINARY UPLOAD
    ///////////////////////////////////////////
    async function uploadToCloudinary(file) {
        const fd = new FormData();
        fd.append("file", file);
        fd.append("upload_preset", UPLOAD_PRESET);

        const res = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
            {
                method: "POST",
                body: fd
            }
        );

        if (!res.ok) {
            throw new Error("Cloudinary upload failed");
        }

        const data = await res.json();
        return data.secure_url;
    }

    ///////////////////////////////////////////
    // LOAD PRODUCTS
    ///////////////////////////////////////////
    async function loadProducts() {
        productList.innerHTML = `<div class="loading">Loading...</div>`;

        try {
            const res = await fetch(`${API_BASE}/products`);
            const products = await res.json();

            productList.innerHTML = "";

            if (products.length === 0) {
                productList.innerHTML = `<div class="loading">No products yet</div>`;
                return;
            }

            products.forEach((p) => {
                const card = document.createElement("div");
                card.className = "product-card";

                card.innerHTML = `
                    <img src="${p.imageUrl}" />
                    <h3>${p.title}</h3>
                    <p>${p.description}</p>
                    <p><strong>${p.price} ${p.currency}</strong></p>

                    <button onclick="editProduct('${p._id}')">Edit</button>
                    <button onclick="deleteProduct('${p._id}')">Delete</button>
                `;

                productList.appendChild(card);
            });
        } catch (err) {
            productList.innerHTML = `<div class="error">Error loading products</div>`;
        }
    }

    ///////////////////////////////////////////
    // CREATE OR UPDATE PRODUCT
    ///////////////////////////////////////////
    productForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        let imageUrl = currentImageUrl;

        // If new picture chosen â†’ upload to Cloudinary
        if (selectedFile) {
            try {
                imageUrl = await uploadToCloudinary(selectedFile);
            } catch (err) {
                alert("Image upload failed");
                return;
            }
        }

        const body = {
            title: document.getElementById("productName").value,
            description: document.getElementById("productDescription").value,
            metadata: {
                size: document.getElementById("productSize").value,
                brand: document.getElementById("productBrand").value
            },
            price: document.getElementById("productPrice").value,
            currency: document.getElementById("productCurrency").value,
            imageUrl
        };

        let url = `${API_BASE}/admin/products`;
        let method = "POST";

        if (editingProductId) {
            url = `${API_BASE}/admin/products/${editingProductId}`;
            method = "PUT";
        }

        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!res.ok) return alert(data.error || "Failed");

        alert(editingProductId ? "Updated!" : "Created!");

        resetForm();
        loadProducts();
    });

    ///////////////////////////////////////////
    // EDIT PRODUCT
    ///////////////////////////////////////////
    window.editProduct = async (id) => {
        const res = await fetch(`${API_BASE}/products/${id}`);
        const p = await res.json();

        editingProductId = id;

        document.getElementById("productName").value = p.title;
        document.getElementById("productDescription").value = p.description;
        document.getElementById("productSize").value = p.metadata?.size || "";
        document.getElementById("productBrand").value = p.metadata?.brand || "";
        document.getElementById("productPrice").value = p.price;
        document.getElementById("productCurrency").value = p.currency;

        currentImageUrl = p.imageUrl;

        photoArea.innerHTML = `
            <img src="${p.imageUrl}" style="max-width:100%; height:auto;" />
        `;

        selectedFile = null;
    };

    ///////////////////////////////////////////
    // DELETE PRODUCT
    ///////////////////////////////////////////
    window.deleteProduct = async (id) => {
        if (!confirm("Delete this?")) return;

        const res = await fetch(`${API_BASE}/admin/products/${id}`, {
            method: "DELETE"
        });

        if (res.ok) {
            alert("Deleted");
            loadProducts();
        }
    };

    ///////////////////////////////////////////
    // RESET FORM
    ///////////////////////////////////////////
    function resetForm() {
        productForm.reset();
        photoArea.innerHTML = "Photo";
        selectedFile = null;
        editingProductId = null;
        currentImageUrl = null;
    }

    // Load products initially
    loadProducts();
});
</script>
</body>
</html>